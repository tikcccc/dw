# DWSS-BIM 仪表板产品需求文档 (PRD)

## 一、文档信息 (Cover & Meta)

| 字段 | 内容 |
| --- | --- |
| 项目名称 | DWSS-BIM 集成仪表板系统 |
| 文档版本 | V1.0.0 |
| 版本历史 | 见修订记录 |
| 更新时间 | 2025-01-08 |
| 产品经理 | 产品团队 |
| 参与人员 | 开发 / 测试 / 设计 / 运营 |

## 二、修订记录

| 版本号 | 日期 | 内容描述 | 作者 | 状态 |
| --- | --- | --- | --- | --- |
| V1.0.0 | 2025-01-08 | 初稿创建，包含完整功能规格和用户故事 | 产品团队 | 待评审 |

## 三、背景与目标

### **1.1. 概述**

本文档旨在详细说明 DWSS-BIM 仪表板的产品需求。该平台旨在将数字工程监督系统（DWSS）与通用数据环境（CDE）——特别是 Autodesk Construction Cloud (ACC)/BIM360 ——中的建筑信息模型（BIM）数据进行集成。

本次集成的主要目标是通过打破 BIM 模型、RISC 表单及其他项目文档之间的数据壁垒，为项目监管创建一个无缝且高效的工作流程。该仪表板将为所有利益相关者提供一个集中的、直观的、且权限分明的可视化协同工作平台。

### **1.2. 业务目标**

- **强化项目监管：** 通过将 BIM 模型与 DWSS 数据和施工文档相关联，提供施工信息的全景视图。
- **简化工作流程：** 自动化数据录入，提升创建 RISC 表单等流程的效率。
- **提升数据可访问性：** 使用户能够直接在 DWSS 环境中轻松访问、筛选和可视化 BIM 相关数据。
- **提高准确性：** 通过直接从 BIM 模型中提取数据，减少手动操作错误。
- **版本控制管理：** 提供完整的文件版本跟踪和历史记录功能。

### **1.3. 范围**

**范围内：**

- 开发 DWSS-BIM 仪表板。
- 与 Autodesk ACC/BIM360 集成，用于用户认证和数据访问。
- 使用 `HyD Data-Link Code` 查看和筛选 BIM 模型的功能。
- 将 RISC 表单和 ACC 文档链接到 BIM 对象。
- 使用 BIM 对象中的数据填充 RISC 表单的功能。
- 仪表板内的用户角色和权限管理。
- 关键用户操作的活动日志记录。
- 文件上传时间和更新时间的精确跟踪。
- 重复文件检测和防止重复上传功能。

**范围外：**

- RISC 表单的创建、提交和审批（此功能保留在现有的 DWSS 平台内）。
- BIM 模型及其参数的创建和管理（这是 BIM 团队的职责）。
- CDE (ACC/BIM360) 内的用户管理。

### **1.4. 术语表**

| 术语 | 定义 |
| --- | --- |
| **ACC** | Autodesk Construction Cloud，一个 CDE 平台。 |
| **BIM** | 建筑信息模型，一个用于创建和管理建设项目信息的过程。 |
| **CDE** | 通用数据环境，项目的单一信息源。 |
| **DWSS** | 数字工程监督系统。 |
| **HyD Data-Link Code** | 用于选择和筛选 BIM 对象的自定义参数。 |
| **RISC 表单** | 检查与勘测申请表，DWSS 中的关键文档。 |
| **上传时间** | 文件第一次与项目构件创建关联的时间。 |
| **更新时间** | 文件与任何构件关联被修改后记录的时间。 |
| **My uploaded files** | 用户上传文件到平台并与构件创建初始关联的标识。 |

## **2. 用户角色与权限**

DWSS-BIM 仪表板内的用户角色及其权限由系统管理员管理，但通过用户的 CDE (ACC/BIM360) 账户进行认证。系统将尊重用户在 CDE 中的原始文件访问权限。

| 角色 | 查看权限 | 操作权限 | 系统权限 |
| --- | --- | --- | --- |
| **普通用户 (View-only User)** | - 在其 CDE 权限范围内，查看所有项目、模型以及关联的 RISC 表单和 ACC 文件。<br> - 查看链接到特定 BIM 构件的文档和表单。<br> - 查看文件的上传时间和更新时间信息。 | 无。 | - 必须拥有一个已授权的关联邮箱。 |
| **授权用户 (Authorized User)** | - 拥有普通用户的所有权限。<br> - 可以查看"My uploaded files"筛选器中的自己上传的文件。 | - 新增文件（系统自动记录上传时间）。<br> - 修改/删除自己上传的文件。<br> - 修改自己提交过的文件的绑定关系（进入"绑定模式"）。<br> - 文件关联修改时自动更新"更新时间"。 | - 必须拥有一个已授权的关联邮箱。 |
| **管理员 (Administrator)** | - 无范围限制地查看所有项目、模型、RISC 表单和 ACC 文件。<br> - 查看所有用户和仪表板的活动日志。<br> - 查看所有文件的完整时间记录。 | - 对所有文件执行所有操作（新增、删除、修改绑定）。<br> - 通过邮箱邀请用户进入仪表板。<br> - 管理文件的上传时间和更新时间记录。 | - 访问独立的管理后台。<br> - 管理已通过 CDE 登录用户的系统内角色及权限。 |

### 2.1 通过CDE授权与登录 (Authorization and Login via CDE)

系统采用与通用数据环境 (CDE) 集成的单点登录（SSO）方案。所有用户都必须通过其 CDE (ACC/BIM360) 账户进行认证和授权。

### 2.1.1 授权与登录流程

1. **入口**: 在系统的登录页面，用户会看到一个主登录按钮："ACC/BIM360 Account Sign in"。
2. **认证**: 用户点击该按钮后，将被重定向至 Autodesk 官方的统一认证页面。
3. **授权**: 首次登录的用户在成功认证后，会被引导至一个"Authorize application"页面，用户必须点击"Allow (允许)"按钮来授予权限。
4. **访问**: 用户成功授权后，将被重定向回 DWSS-BIM 仪表板，并以其 CDE 账户身份登录。

### 2.2 角色分配与权限管理

- 管理员通过邮箱邀请用户授权进入仪表盘，并分配角色。
- **权限继承**: 高级角色继承低级角色的所有权限。

## 3. 核心实体与数据模型

### **高层系统架构**

系统将采用 OAuth 2.0 协议与 CDE 进行安全认证。DWSS-BIM 仪表板将使用 CDE 的 API 来检索 BIM 模型、文档和用户权限数据。

| 实体 (Entity) | 关键数据属性 (Data Attributes) | 描述 |
| --- | --- | --- |
| **BIM 构件(BIM Component)** | - `componentId` (唯一ID)<br> - `version` (所属版本)<br> - `modelVersionId` (模型版本ID)<br> - `name` (构件名称)<br> - `objectGroup` (对象组)<br> - `hydCode` (HyD代码)<br> - `properties` (属性信息) | BIM 模型中的最小可交互单元，支持多版本管理 |
| **RISC 表单(RISC Form)** | - `riscId` (唯一ID)<br> - `requestNo` (请求编号)<br> - `status` (状态)<br> - `updateDate` (更新日期)<br> - `linkedObjectIds` (关联构件列表)<br> - `bindingStatus` (绑定状态)<br> - `boundModelVersionId` (绑定的模型版本ID)<br> - `createdBy` (创建者)<br> - `hydCode` (HyD代码) | 项目管理中的请求检查/勘测证书 |
| **文件(File)** | - `fileId` (唯一ID)<br> - `fileName` (文件名)<br> - `fileType` (文件类型)<br> - **`uploadDate` (上传时间)**<br> - **`updateDate` (更新时间)**<br> - `linkedObjectIds` (关联构件列表)<br> - `bindingStatus` (绑定状态)<br> - `boundModelVersionId` (绑定的模型版本ID)<br> - **`uploadedBy` (上传者)**<br> - `hydCode` (HyD代码)<br> - `version` (版本号) | 关联到BIM模型的各类文档，包含完整的时间跟踪信息 |
| **操作日志(Activity Log)** | - `logId` (唯一ID)<br> - `user` (操作者)<br> - `action` (动作)<br> - `target` (目标)<br> - `targetDetail` (目标详情)<br> - `details` (详情)<br> - `timestamp` (时间戳)<br> - `userRole` (用户角色)<br> - `ip` (IP地址) | 记录系统内的所有关键操作 |

### 3.1 文件时间管理规范

#### 3.1.1 上传时间 (Upload Time)
- **定义**: 此文件第一次和项目构件创建关联的时间
- **特征**: 
  - 即使文件之后与另一个构件创建初始关联，此日期也指向第一次创建关联的时间
  - 一旦设定，永远不会改变
  - 与"上传者"(uploadedBy)同时确立

#### 3.1.2 更新时间 (Update Time)
- **定义**: 此文件与任何构件关联被修改后记录的时间
- **更新触发条件**:
  - 文件新增关联的时间（并非第一次创建关联）
  - 文件删除关联的时间
  - 文件绑定关系的任何变更
- **特征**: 每次关联变更都会更新此时间戳

#### 3.1.3 My uploaded files 标识
- **定义**: 上传此文件到平台并与构件创建初始关联的用户标识
- **特征**: 
  - 与上传时间同时建立
  - 用于"My uploaded files"筛选功能
  - 不会因为文件关联变更而改变

## 4. 交互逻辑与功能规格

### 4.0 界面布局 (Interface Layout)

仪表板采用响应式的三栏式布局，为用户提供灵活的工作空间。

| 栏目 | 内容 | 交互特性 |
| --- | --- | --- |
| **左侧栏 (Left Sidebar)** | - HyD Code 筛选器<br> - RISC 表单列表 | - 可通过边缘的切换按钮收起/展开，以最大化中央视图区域。 |
| **中央区域 (Center Panel)** | - BIM 模型查看器 (3D View)<br> - 版本切换控件<br> - 构件高亮显示 | - 核心交互区域，显示和操作BIM模型。<br> - 支持当前版本和历史版本切换。 |
| **右侧栏 (Right Sidebar)** | - 文件列表<br> - 绑定管理面板 (绑定模式下显示)<br> - 文件上传功能 | - 可独立收起或展开。<br> - 显示文件的上传时间和更新时间。 |

### 4.1 核心筛选逻辑

#### 4.1.1 HyD Code 高级筛选

这是主要的全局筛选器，用于从工程结构的角度逐级探索数据，精确定位构件。

- **UI**: 由多个层级关联的下拉菜单构成 (Project, Originator, Volume, System, Location, Discipline, Sequential Number)。
- **逻辑**: 选择筛选条件后，中央视图中匹配的构件将自动进入"筛选高亮集"并高亮显示。
- **权限**: 普通用户、授权用户、管理员均可使用。

#### 4.1.2 列表属性与筛选方式

##### 4.1.2.1 RISC 表单

**表格字段设置**

| 属性 | UI 展现 | 描述 |
| --- | --- | --- |
| 请求编号 (RequestNo.) | 文本链接 | 表单的唯一编号，可点击跳转至详情页 |
| 更新日期(Update Date) | 日期文本 | 表单最后一次更新的时间 |
| 状态(Status) | 状态徽章 | 以不同颜色的徽章展示表单当前的工作流状态。状态：Approved 、 Submitted 、Rejected |
| 绑定状态 | 图标 | 图标显示在条目末尾，直观展示其关联关系的时效性。详见 4.2.4 |

**筛选方式字段设置**

| 筛选方式 | UI 控件 | 用途与逻辑 |
| --- | --- | --- |
| 按状态筛选 | 下拉菜单 | 用于按表单的当前工作流状态进行筛选 |
| 按日期筛选 | 日期范围选择器 | 允许用户筛选在特定时间段内有更新或提交的表单 |

##### 4.1.2.2 文件

**表格字段设置**

| 属性 | UI 展现 | 描述 |
| --- | --- | --- |
| 文件名字(File Name) | 文本链接 | 文件名，可点击跳转至详情页 |
| **上传日期(Upload Date)** | **日期文本** | **文件初始上传并创建关联的时间（不会改变）** |
| **更新日期(Update Date)** | **日期文本** | **文件关联最后一次修改的日期** |
| 绑定状态图标 | 图标 | 显示在条目末尾，直观展示其关联关系的时效性。详见 4.2.4 |
| 文件类型(File Type) | 文本/标签 | 施工方案 (Method Statement)、物料提交 (Material Submission)、施工图纸 (Working Drawings)、测试报告 (Test Result) |
| **上传者(Uploaded By)** | **文本显示** | **文件的上传者名称和角色** |

**筛选方式字段设置**

| 筛选方式 | UI 控件 | 用途与逻辑 |
| --- | --- | --- |
| 按名字搜索 | 文本搜索框 | 提供按文件名关键词进行快速查找的功能 |
| 按日期筛选 | 日期范围选择器 | 允许用户筛选在特定时间段内上传或更新的文件 |
| 按文件类型筛选 | 下拉菜单 | 按文档类型进行筛选 |
| **My uploaded files** | **勾选按钮** | **筛选出自己上传的文件（基于uploadedBy字段）** |

### 4.2 视图交互逻辑

| 交互动作 | 场景 | 结果 |
| --- | --- | --- |
| **单击 (Single-Click)** | 1. 单击BIM构件<br> 2. 单击RISC/文件列表项 | 1. 将构件加入"手动高亮集"，联动筛选左右列表。<br> 2. 清空旧的手动高亮集，将条目关联构件设为新的高亮集，并筛选另一个列表。 |
| **悬浮 (Hover)** | 悬浮于列表项上 | 临时高亮其关联的BIM构件，用于快速预览位置。 |
| **右键 (Context Menu)** | 在BIM构件或模型零件树上右键 | 弹出快捷菜单，提供"管理关联文件"、"添加到绑定面板"等功能。 |

#### 4.2.1 HyD筛选与列表项交互的特殊逻辑

当HyD筛选器处于激活状态时，列表项点击会触发特殊处理逻辑：

- **情况1**: 点击项目的关联构件全部在HyD筛选范围内 → 直接高亮显示构件
- **情况2**: 点击项目的关联构件超出HyD筛选范围 → 显示确认对话框，询问是否清除筛选器以查看所有相关构件
- **确认对话框功能**: 确保用户取消操作时不会产生副作用

#### 4.2.2 绑定状态图标系统 (Binding Status Icon System)

为使用户能即时了解关联关系的时效性，RISC 表单和文件列表中，每个条目都需显示一个绑定状态图标。

| 图标 | 显示逻辑 (Logic) | 业务含义 |
| --- | --- | --- |
| （无图标） | 条目关联的所有构件ID，在BIM模型中都属于最新版本 | 关联关系正常且有效 |
| 历史图标(History Icon) | 条目关联的构件ID中，在BIM模型中不属于最新版本 | 提醒用户该关联指向的是一个旧版本的构件，可能需要更新或核实 |
| 删除图标 (Deleted/Ghost Icon) | 条目关联的构件ID中在最新版本的BIM模型中已不存在（被删除） | 表明用户该关联指向的是一个旧版本的构件，关联的构件在最新版本中已不存在 |

### 4.3 对象操作 (CRUD Operations)

#### 4.3.1 RISC 表单

- **创建**: 创建并不在仪表盘上进行，在DWSS自己的平台。
- **查看**: 可查看所有表单，表单状态由DWSS自己的平台决定。

#### 4.3.2 文件

- **添加**: 
  - 授权用户: 可添加文件，系统自动记录上传时间和上传者
  - 管理员: 可直接操作
  - **重复检测**: 系统会检查文件名是否已存在，防止重复上传
- **删除/修改**:
  - 授权用户: 可以删除/修改属于自己上传的文件
  - 管理员: 可直接操作所有文件
  - **时间记录**: 任何修改都会更新"更新时间"
- **修改绑定**: 
  - 通过"绑定购物车"模式进行
  - 每次绑定修改都会更新"更新时间"

### 4.4 版本与对比逻辑

- **版本切换**: 用户可在BIM视图右上方切换模型版本，切换后视图、高亮、列表将全部重置刷新。
- **历史追溯**: 单击标记为"历史"或"已删除"的条目，将触发一个**可拖动**的"历史视图浮窗"。
- **浮窗功能**: 浮窗内展示新旧版本信息和变更说明，并提供一个"切换视图"按钮，允许用户在当前BIM视图和该构件所属的历史BIM视图之间来回切换，实现直观的版本追溯。

### 4.5 以构件为中心的关联流程

此流程用于将文件首次关联到模型构件。

1. **选择构件**: 在BIM视图中通过单击或筛选高亮一个或多个构件。
2. **触发**: 在高亮构件上右键，选择"管理关联文件"。
3. **文件管理**: 系统将打开一个全屏的文件管理页面，其中包含一个模拟的ACC文件浏览器。
4. **关联**: 用户可从此浏览器中选择文件，进行"上传"（添加至系统列表），并与最初选中的构件建立关联。
5. **时间记录**: 系统自动记录上传时间和上传者信息。

### 4.6 文件编辑与提交流程 (绑定模式)

此流程专用于精细化编辑**一个文件**与**多个构件**的关联关系。

- **触发**: 授权用户或管理员点击文件列表项上的"修改绑定(链接图标)"。
- **UI变化**:
  1. 系统进入"绑定模式"。
  2. 右侧面板出现"绑定管理面板"(绑定购物车)，并将当前文件锁定在内。
  3. BIM视图上方出现"添加所有高亮构件"按钮。
- **操作逻辑**:
  1. **文件锁定**: 绑定模式中，操作核心为购物车中的唯一文件。
  2. **收集构件**: 用户在BIM视图中通过筛选或单击高亮构件，然后点击"添加所有高亮构件"按钮，将构件批量加入购物车。
  3. **版本限制**: 加入购物车的**所有构件必须属于同一个BIM模型版本**，禁止跨版本绑定。
  4. **提交**: 点击"提交绑定"，经二次确认后，更新文件的关联关系和更新时间，并退出绑定模式。

### 4.7 文件上传流程

#### 4.7.1 上传模态窗口

- **步骤1**: 文件选择 - 从ACC平台树形结构中选择文件
- **步骤2**: 文件配置 - 为每个选中文件分配文件类型
- **步骤3**: 上传完成 - 显示上传进度和成功确认

#### 4.7.2 重复文件检测

- **检测时机**: 在用户点击"开始上传"后，文件类型验证通过后
- **检测逻辑**: 系统检查选中文件的文件名是否已存在于当前文件列表中
- **处理方式**: 
  - 如发现重复文件，显示错误提示
  - 列出所有重复的文件名
  - 要求用户取消选择重复文件或删除已有文件后再上传

#### 4.7.3 文件类型管理

支持的文件类型包括：
- 施工方案 (Method Statement)
- 物料提交 (Material Submission)  
- 施工图纸 (Working Drawings)
- 测试报告 (Test Result)

## 5. 管理员后台功能 (Administrator Functions)

### 5.1 用户与角色管理 (User and Role Management)

- **入口**: 管理后台 > 用户管理。
- **界面**: 展示所有已通过 CDE 登录过的用户列表。
- **功能逻辑**:
  1. **邀请用户**: 管理员通过邮箱发送邀请用户加入仪表盘的链接，并分配用户角色。
  2. **角色分配与状态管理**: 管理员可修改用户的系统角色（普通用户/授权用户/管理员）和删除用户。
  3. **批量操作**: 支持批量修改用户角色或状态。
  4. **搜索与筛选**: 提供高级搜索和筛选功能，便于管理大量用户。

### 5.2 活动日志管理

#### 5.2.1 日志内容与功能

- **日志内容 (Data Columns)**:
  - `时间戳 (Timestamp)`: 精确到秒的操作时间。
  - `用户 (User)`: 执行操作的用户名或ID。
  - `角色 (Role)`: 执行操作时用户的角色（Admin/Authorized User/View-only User）。
  - `IP 地址 (IP Address)`: 操作来源的IP地址。
  - `操作类型 (Action Type)`: 结构化的动作分类，例如 `LOGIN_SUCCESS`, `FILE_BIND_SUBMIT`, `FILE_UPLOAD`, `USER_ROLE_CHANGE` 等。
  - `操作目标 (Target)`: 描述操作影响的实体类型，如 `File`, `RISC Form`, `BIM Object`, `User`。
  - `目标详情 (Target Detail)`: 具体的实体ID或名称，例如文件名"施工图.pdf"或RISC表单号"RISC-003"。
  - `操作详情 (Details)`: 对操作的完整文字描述，包括时间相关信息。

#### 5.2.2 时间相关日志记录

特别记录以下时间相关操作：
- **文件上传**: 记录上传时间和上传者
- **关联修改**: 记录更新时间和修改详情
- **绑定操作**: 记录绑定时间和相关构件信息

#### 5.2.3 搜索与筛选方式

1. **基础筛选**:
   - 按**用户**筛选（输入框）。
   - 按**角色**筛选（下拉菜单：Admin / Authorized User / View-only User）。
   - 按**日期范围**筛选。
2. **全文搜索**: 提供一个主搜索框，可以对"目标详情"和"操作详情"列进行关键词全文搜索。

#### 5.2.4 导出功能

- **导出功能**: 管理员可将当前筛选出的日志结果导出为标准格式文件（如 CSV 或 Excel）。
- **导出按钮**: 位于日志列表的右上角。

## 6. 技术规格与约束

### 6.1 性能要求

- **响应时间**: 界面交互响应时间不超过200毫秒
- **并发用户**: 支持最多100个并发用户同时操作
- **数据加载**: 大型BIM模型加载时间不超过10秒

### 6.2 数据完整性

- **时间戳精度**: 所有时间记录精确到秒级
- **数据一致性**: 确保上传时间和更新时间的逻辑一致性
- **版本控制**: 严格的版本控制，防止跨版本数据混乱

### 6.3 用户体验

- **响应式设计**: 支持桌面端和平板端访问
- **多语言支持**: 界面支持中英文双语
- **无障碍访问**: 符合WCAG 2.1 AA标准

## 7. 验收标准

### 7.1 功能验收

- [ ] 所有用户角色权限按规范实现
- [ ] 文件上传时间和更新时间准确记录
- [ ] "My uploaded files"筛选功能正常
- [ ] 重复文件检测功能有效
- [ ] 绑定模式一对多关联正常
- [ ] HyD筛选器七级筛选正常
- [ ] 版本管理功能完整

### 7.2 性能验收

- [ ] 界面响应时间符合要求
- [ ] 大文件上传稳定可靠
- [ ] 并发用户操作无冲突
- [ ] 系统稳定性达到99.9%

### 7.3 安全验收

- [ ] 用户权限控制严格
- [ ] 数据访问日志完整
- [ ] 文件操作权限正确
- [ ] 系统漏洞扫描通过

---

**文档版本**: 1.0  
**最后更新**: 2025-01-08  
**文档状态**: 待评审